<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>隨機卡圖鑑</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
h1 { text-align: center; }

.filters { margin-bottom: 20px; text-align: center; }
select { margin: 0 10px; padding: 5px; }

.grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
  gap: 12px; 
}

.card { 
  background: #fff; 
  border-radius: 12px; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.12); 
  padding: 10px; 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  justify-content: flex-start;
  overflow: hidden;
}

.card img { 
  max-height: 150px;       /* 圖片高度上限 */
  width: auto;             /* 自動寬度保持比例 */
  display: block; 
  margin: 0 auto; 
  object-fit: contain;      /* 保持比例，不裁切 */
  border-radius: 8px;
  cursor: pointer;          /* 提示可點擊 */
}

.card .meta { 
  margin-top: 10px; 
  text-align: center; 
  font-size: 0.9em; 
  color: #555; 
}

.card .meta div {
  margin: 2px 0; /* 三行資訊間距 */
}

/* 響應式調整 */
@media (max-width: 768px) {
  .card img { max-height: 40vw; }
}
@media (max-width: 480px) {
  .card img { max-height: 50vw; }
}

/* Lightbox */
#lightbox {
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#lightbox-bg {
  position: absolute;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.8);
}

#lightbox-img {
  max-width: 90%;
  max-height: 90%;
  z-index: 10000;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

#lightbox-close {
  position: absolute;
  top: 20px;
  right: 30px;
  color: #fff;
  font-size: 36px;
  font-weight: bold;
  cursor: pointer;
  z-index: 10001;
}
</style>
</head>
<body>
<h1>隨機卡圖鑑</h1>

<div class="filters">
  <select id="yearFilter">
    <option value="">全部年份</option>
  </select>
  <select id="themeFilter">
    <option value="">全部系列</option>
  </select>
  <select id="memberFilter">
    <option value="">全部成員</option>
  </select>
</div>

<div class="grid" id="cardGrid"></div>

<!-- Lightbox -->
<div id="lightbox">
  <div id="lightbox-bg"></div>
  <img id="lightbox-img" src="" alt="">
  <span id="lightbox-close">&times;</span>
</div>

<script>
const sheetURL = 'https://opensheet.elk.sh/1FJLx_6Jp_qJ908AHmSsXNopTI4m9NV048J59oXKXL9A/1';
let allCards = [];

// 隨機排序
function shuffleArray(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]] = [array[j],array[i]];
  }
  return array;
}

// Lightbox
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxClose = document.getElementById('lightbox-close');
const lightboxBg = document.getElementById('lightbox-bg');

function openLightbox(src){
  lightboxImg.src = src;
  lightbox.style.display = 'flex';
}

function closeLightbox(){
  lightbox.style.display = 'none';
}

lightboxClose.addEventListener('click', closeLightbox);
lightboxBg.addEventListener('click', closeLightbox);

// render 卡片
function renderCards(cards){
  const grid = document.getElementById('cardGrid');
  grid.innerHTML = '';
  cards.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img src="${c.img}" alt="${c.member}">
      <div class="meta">
        <div>${c.member}</div>
        <div>${c.year}</div>
        <div>${c.theme}</div>
      </div>
    `;
    const imgEl = div.querySelector('img');
    imgEl.addEventListener('click', ()=>openLightbox(c.img));
    grid.appendChild(div);
  });
}

// 解析檔名編號
function getNumber(name){
  const parts = name.split('_');
  return parts.length>3 ? parseInt(parts[3]) : 0;
}

// 篩選與排序邏輯
function applyFilters(){
  const yearVal = document.getElementById('yearFilter').value;
  const themeVal = document.getElementById('themeFilter').value;
  const memberVal = document.getElementById('memberFilter').value;

  let filtered = allCards.filter(c=>{
    return (!yearVal || c.year === yearVal) &&
           (!themeVal || c.theme === themeVal) &&
           (!memberVal || c.member === memberVal);
  });

  if(!yearVal && !themeVal && !memberVal){
    filtered = shuffleArray(filtered); // 全部隨機
  } else if(yearVal && !themeVal && !memberVal){
    filtered = shuffleArray(filtered); // 只選年份 → 隨機
  } else if(themeVal){
    filtered.sort((a,b)=>{
      if(a.member<b.member) return -1;
      if(a.member>b.member) return 1;
      return getNumber(a.img)-getNumber(b.img);
    });
  } else if(memberVal && !yearVal && !themeVal){
    filtered.sort((a,b)=>{
      if(a.year<b.year) return -1;
      if(a.year>b.year) return 1;
      if(a.theme<b.theme) return -1;
      if(a.theme>b.theme) return 1;
      return getNumber(a.img)-getNumber(b.img);
    });
  }

  renderCards(filtered);
}

// 生成篩選選單
function populateFilters(cards){
  const yearSet = new Set(cards.map(c=>c.year));
  const themeSet = new Set(cards.map(c=>c.theme));
  const memberSet = new Set(cards.map(c=>c.member));

  const yearSelect = document.getElementById('yearFilter');
  const themeSelect = document.getElementById('themeFilter');
  const memberSelect = document.getElementById('memberFilter');

  yearSet.forEach(y=>{
    const option = document.createElement('option');
    option.value = y;
    option.textContent = y;
    yearSelect.appendChild(option);
  });
  themeSet.forEach(t=>{
    const option = document.createElement('option');
    option.value = t;
    option.textContent = t;
    themeSelect.appendChild(option);
  });
  memberSet.forEach(m=>{
    const option = document.createElement('option');
    option.value = m;
    option.textContent = m;
    memberSelect.appendChild(option);
  });

  [yearSelect, themeSelect, memberSelect].forEach(sel=>{
    sel.addEventListener('change', applyFilters);
  });
}

// fetch Sheet
fetch(sheetURL)
  .then(r=>r.json())
  .then(data=>{
    allCards = data;
    renderCards(shuffleArray([...allCards])); // 初始隨機
    populateFilters(allCards); // 初始化篩選選單
  });
</script>
</body>
</html>
