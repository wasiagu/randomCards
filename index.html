<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>小卡圖鑑</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    .filters { margin-bottom: 20px; text-align: center; }
    select { margin: 0 10px; padding: 5px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(150px,1fr)); gap: 12px; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); padding: 10px; text-align: center; }
    .card img { width: 100%; border-radius: 8px; }
    .card .meta { margin-top: 6px; font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <h1>小卡圖鑑</h1>
  <div class="filters">
    <select id="memberFilter">
      <option value="">全部成員</option>
    </select>
  </div>
  <div class="grid" id="cardGrid"></div>

<script>
const sheetURL = 'https://opensheet.elk.sh/1FJLx_6Jp_qJ908AHmSsXNopTI4m9NV048J59oXKXL9A/1';
let allCards = [];

// 隨機排序函式
function shuffleArray(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]] = [array[j],array[i]];
  }
  return array;
}

// render 卡片
function renderCards(cards){
  const grid = document.getElementById('cardGrid');
  grid.innerHTML = '';
  cards.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img src="${c.img}" alt="${c.member}">
      <div class="meta">${c.member}<br>${c.year} • ${c.theme}</div>
    `;
    grid.appendChild(div);
  });
}

// 生成篩選選單
function populateFilter(cards){
  const memberSet = new Set(cards.map(c=>c.member));
  const select = document.getElementById('memberFilter');
  memberSet.forEach(m=>{
    const option = document.createElement('option');
    option.value = m;
    option.textContent = m;
    select.appendChild(option);
  });

  select.addEventListener('change', ()=>{
    const val = select.value;
    if(val === ''){
      // 無篩選 → 隨機排序
      renderCards(shuffleArray([...allCards]));
    } else {
      // 篩選後 → member + 編號排序
      const filtered = allCards.filter(c=>c.member===val);
      filtered.sort((a,b)=>{
        // 先比 member (其實都是同一個值，可保留)
        if(a.member<b.member) return -1;
        if(a.member>b.member) return 1;
        // 再比檔名編號
        const getNumber = name=>{
          const parts = name.split('_');
          return parts.length>3?parseInt(parts[3]):0;
        }
        return getNumber(a.img) - getNumber(b.img);
      });
      renderCards(filtered);
    }
  });
}

// fetch Sheet
fetch(sheetURL)
  .then(r=>r.json())
  .then(data=>{
    allCards = data;
    renderCards(shuffleArray([...allCards])); // 初始隨機
    populateFilter(allCards); // 初始化篩選選單
  });
</script>
</body>
</html>
